name: ğŸš€ CI/CD Pipeline - SportPool

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  
jobs:
  # Job 1: Tests et QualitÃ© du Code
  test-and-quality:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --silent
        
    - name: ğŸ” Lint check
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint
        
    - name: ğŸ¨ Format check
      run: |
        echo "ğŸ¨ Checking code formatting..."
        npm run format:check
        
    - name: ğŸ§ª Run unit tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        npm run test
        
    - name: ğŸŒ Build application
      run: |
        echo "ğŸŒ Building application..."
        npm run build
        
    - name: ğŸ­ Run E2E tests
      run: |
        echo "ğŸ­ Running end-to-end tests..."
        npm run test:e2e || echo "E2E tests optional for now"

  # Job 2: Security Audit
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: test-and-quality
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --silent
      
    - name: ğŸ”’ Run security audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level=high || true

  # Job 3: DÃ©ploiement (seulement sur main)
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [test-and-quality, security-audit]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ® Display ASCII Art
      run: |
        echo "ğŸ® CovoitSport Deployment Starting..."
        cat << 'EOF'
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
        â•‘ â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â• â•‘  
        â•‘ â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â•‘
        â•‘ â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â•‘
        â•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘    â•‘
        â•‘  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•   â•šâ•â•â•â•   â•šâ•â•â•â•â•â• â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•      â•šâ•â•â•â•â•â•    â•šâ•â•    â•‘
        â•‘                                                                                   â•‘
        â•‘                           ğŸ† BY LTHEBEST ğŸ†                                       â•‘
        â•‘                                                                                   â•‘
        â•‘        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â•‘
        â•‘        â•‘  ğŸš— Plateforme de Covoiturage Sportif de Nouvelle GÃ©nÃ©ration  ğŸš—  â•‘      â•‘
        â•‘        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EOF
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --silent
      
    - name: ğŸŒ Build for production
      run: npm run build
      
    - name: ğŸš€ Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "ğŸš€ Triggering Render deployment..."
        if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}' || echo "Deployment trigger failed - continuing..."
        else
          echo "âš ï¸ Render API credentials not configured. Skipping API deployment trigger."
          echo "Render will auto-deploy from GitHub integration."
        fi
        
    - name: âœ… Deployment Success Message
      run: |
        echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
        echo "ğŸŒ Application disponible sur: https://sportpool.onrender.com"
        echo "ğŸ® CovoitSport By LtheBest - PrÃªt pour l'aventure sportive! ğŸ†"

  # Job 4: Post-Deploy Health Check
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ¥ Wait for deployment and health check
      run: |
        echo "ğŸ¥ Waiting for deployment to be ready..."
        sleep 60
        
        echo "ğŸ©º Checking application health..."
        for i in {1..10}; do
          if curl -f -s "https://sportpool.onrender.com/api/health" > /dev/null; then
            echo "âœ… Application is healthy!"
            exit 0
          else
            echo "â³ Attempt $i/10 - Application not ready yet, waiting 30s..."
            sleep 30
          fi
        done
        
        echo "âš ï¸ Health check failed after 10 attempts"
        exit 1

  # Job 5: Notification
  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.deploy.result == 'success' && needs.health-check.result == 'success'
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI!"
        echo "âœ… Tests: PASSÃ‰S"
        echo "âœ… DÃ©ploiement: RÃ‰USSI"  
        echo "âœ… Health Check: OK"
        echo "ğŸŒ Application: https://sportpool.onrender.com"
        
    - name: ğŸ“¢ Failure Notification  
      if: needs.deploy.result == 'failure' || needs.health-check.result == 'failure'
      run: |
        echo "âŒ Ã‰CHEC DU DÃ‰PLOIEMENT"
        echo "ğŸ” VÃ©rifiez les logs ci-dessus"
        echo "ğŸ› ï¸ Action requise pour corriger les erreurs"